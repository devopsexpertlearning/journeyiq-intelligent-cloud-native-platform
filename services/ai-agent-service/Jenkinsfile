pipeline {
    agent any
    environment {
        PROJECT_ID = 'journeyiq-prod'
        SERVICE_NAME = 'ai-agent-service'
        CANARY_TAG = "us-central1-docker.pkg.dev/${PROJECT_ID}/journeyiq-services/${SERVICE_NAME}:${BUILD_NUMBER}-canary"
    }
    stages {
        stage('Build Canary') {
            steps {
                sh "docker build -t ${CANARY_TAG} ."
                sh "docker push ${CANARY_TAG}"
            }
        }
        stage('Deploy Canary') {
            steps {
                sh "kubectl set image deployment/ai-agent-canary app=${CANARY_TAG}"
            }
        }
        stage('Canary Analysis') {
            steps {
                script {
                    echo "Checking metrics..."
                    // sleep 60
                    // python check_metrics.py
                }
            }
        }
        stage('Promote to Prod') {
            input {
                message "Promote Canary to Production?"
                ok "Promote"
            }
            steps {
                sh "kubectl set image deployment/${SERVICE_NAME} app=${CANARY_TAG}"
            }
        }
    }
}
