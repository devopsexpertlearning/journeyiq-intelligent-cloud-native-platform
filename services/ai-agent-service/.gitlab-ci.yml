variables:
  PROJECT_ID: "journeyiq-prod"
  SERVICE_NAME: "ai-agent-service"
  CANARY_TAG: "us-central1-docker.pkg.dev/$PROJECT_ID/journeyiq-services/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA-canary"

stages:
  - build-canary
  - deploy-canary
  - verify-canary
  - promote

build_canary:
  stage: build-canary
  script:
    - docker build -t $CANARY_TAG .
    - docker push $CANARY_TAG

deploy_canary:
  stage: deploy-canary
  script:
    - kubectl set image deployment/ai-agent-canary app=$CANARY_TAG

verify_canary:
  stage: verify-canary
  script:
    - echo "Running automated health checks on canary..."
    - python src/canary_check.py

promote_prod:
  stage: promote
  script:
    - kubectl set image deployment/$SERVICE_NAME app=$CANARY_TAG
  when: manual
